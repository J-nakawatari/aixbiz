#!/bin/bash

echo "Changes detected after git pull. Starting build process..."

# フロントエンドの依存関係をチェック
if git diff HEAD@{1} HEAD --name-only | grep -q "frontend/package.json"; then
    echo "Frontend dependencies changed. Installing..."
    cd frontend && npm install && cd ..
fi

# バックエンドの依存関係をチェック
if git diff HEAD@{1} HEAD --name-only | grep -q "backend/package.json"; then
    echo "Backend dependencies changed. Installing..."
    cd backend && npm install && cd ..
fi

# フロントエンドのビルド
echo "Building frontend..."
cd frontend && npm run build && cd ..

# バックエンドのビルド
echo "Building backend..."
cd backend && npm run build && cd ..

# PM2でアプリケーション再起動
echo "Restarting applications..."
pm2 restart aixbiz-frontend aixbiz-backend

echo "Build and restart completed!"